var X=Object.defineProperty;var K=(e,t,r)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var h=(e,t,r)=>(K(e,typeof t!="symbol"?t+"":t,r),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function r(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=r(o);fetch(o.href,s)}})();class P{constructor(t){h(this,"feature_set","");h(this,"num_features",0);h(this,"layers",[]);const r=new z(t);switch(this.feature_set=r.readString(),this.feature_set){case"half-compact":this.num_features=192;break;case"half-piece":this.num_features=768;break;case"half-king-piece":this.num_features=40960;break}const i=256,o=32,s=32;this.layers.push(I.read(r,this.num_features,i,16,16)),this.layers.push(I.read(r,2*i,o,8,32)),this.layers.push(I.read(r,o,s,8,32)),this.layers.push(I.read(r,s,1,8,32)),console.assert(r.isEOF(),"Failed to read entire NN file")}get ft(){return this.layers[0]}static async load(t){let i=await(await fetch(t)).arrayBuffer();return new P(i)}}class I{constructor(){h(this,"num_inputs");h(this,"num_outputs");h(this,"weight");h(this,"bias")}static read(t,r,i,o,s){let l=new I;return l.num_inputs=r,l.num_outputs=i,l.weight=t.readIntArray(r*i,o),l.bias=t.readIntArray(i,s),l}getWeightRow(t){let r=new Array(this.num_inputs);for(let i=0;i<this.num_inputs;i++)r[i]=this.weight[i*this.num_outputs+t];return r}getWeightFT(t,r){return this.weight[t*this.num_outputs+r]}}class z{constructor(t){h(this,"dv");h(this,"offset",0);this.dv=new DataView(t)}readString(){let t="";for(;this.dv.getUint8(this.offset)!==0;)t+=String.fromCharCode(this.dv.getUint8(this.offset++));return this.offset++,t}readU32(){let t=this.dv.getUint32(this.offset,!0);return this.offset+=4,t}readInt8Array(t){let r=new Int8Array(t);for(let i=0;i<t;i++)r[i]=this.dv.getInt8(this.offset++);return r}readInt16Array(t){let r=new Int16Array(t);for(let i=0;i<t;i++)r[i]=this.dv.getInt16(this.offset,!0),this.offset+=2;return r}readInt32Array(t){let r=new Int32Array(t);for(let i=0;i<t;i++)r[i]=this.dv.getInt32(this.offset,!0),this.offset+=4;return r}readIntArray(t,r){switch(r){case 8:return this.readInt8Array(t);case 16:return this.readInt16Array(t);case 32:return this.readInt32Array(t)}}isEOF(){return this.offset===this.dv.byteLength}}const D=["w","b"],x=["P","N","B","R","Q","K"],F=new Map,C=new Map;function G(e,t,r,i,o){let s=4,l=15,A=5,_=t+o%s*l,g=r+Math.floor(o/s)*l;for(let n=0;n<768;n++){if(!F.has(n+""))continue;let[w,p]=F.get(n+""),E=i.getWeightFT(n,o),v=Math.abs(E/300),M="rgba("+(E>0?"0, 255, 0":"255, 0, 0")+", "+v+")";v<=.03||(e.strokeStyle=M,e.beginPath(),e.moveTo(w,p),e.lineTo(_,g),e.stroke())}for(let n=0;n<i.num_outputs;n++){let w=t+n%s*l,p=r+Math.floor(n/s)*l;n==o?(e.fillStyle="gray",e.strokeStyle="white"):(e.fillStyle="#454545",e.strokeStyle="#6A6A6A"),e.lineWidth=1,e.beginPath(),e.arc(w,p,A,0,2*Math.PI),e.closePath(),e.stroke(),e.fill()}e.lineWidth=1}const f=16;function Q(e,t,r,i){console.assert(i.length==64,"Invalid number of cells");let o="#f0d9b5",s="#b58863";for(let l=0;l<64;l++){let A=l%8,_=Math.floor(l/8),g=A*f+t,n=_*f+r;e.fillStyle=(A+_)%2==0?o:s,e.fillRect(g,n,f,f);let{role:w,color:p,opacity:E,text:v,accent:M,coords_key:W}=i[l];if(M&&(e.fillStyle=M,e.fillRect(g,n,f,f)),w&&p){let B=p+w,$=C.get(B);if($){let N=E===void 0?1:E;N>.03&&(e.globalAlpha=N,e.drawImage($,g,n,f,f),e.globalAlpha=1)}}v&&(e.textAlign="left",e.font="4px Arial",e.fillStyle="white",e.fillText(`${v}`,g+1,n+f-1)),W&&F.set(W,[g+f/2,n+f/2])}}function V(e,t,r){for(let i=0;i<12;i++){let o=D[+(i>=6)],s=x[i%6],l=i*150;Q(e,0,l,Array.from({length:64},(_,g)=>{let n=64*i+g,w=t.getWeightFT(n,r),p=Math.abs(w/300);return{text:`${n}`,accent:"rgba("+(w>0?"0, 255, 0":"255, 0, 0")+", "+p+")",coords_key:`${n}`,color:o,role:x[i%6],opacity:p}}));let A=C.get(o+s);A&&e.drawImage(A,-64,l+8*f/2-32/2,32,32)}e.font="20px monospace",e.textAlign="center",e.fillStyle="white",e.fillText("All",f*8/2,-30),e.fillText("[768]",f*8/2,-10)}async function Z(){for(let e of D)for(let t of x){let r=new Image;r.src=`pieces/${e}${t}.svg`,C.set(e+t,r)}}Z();const d=document.querySelector("canvas"),u=d.getContext("2d");let T=150,c=T,b=0,H=0,S=new Array(T+1).fill(null),L=-1;async function U(e){S[e]||L!=-1||(L=e,S[e]=await P.load(`models/half-piece/${e}.nn`),H=S[e].ft.num_outputs-1,m=2,L=-1)}function j(){u.textAlign="left",u.textBaseline="top",u.font="30px monospace",u.fillStyle="white",u.fillText(`↑↓ Step: ${c}`+(L!=-1?` (loading #${L})`:""),10,10),u.fillText(`←→ L1 neuron: ${b}`,10,45),u.fillText("(shift x10)",10,80)}async function J(){if(u.imageSmoothingEnabled=!1,S[c]){const e=S.lastIndexOf(null);e!=-1&&U(e);const t=S[c],r=12*150,i=256/4*15;G(u,400,r/2-i/2,t.ft,b),V(u,t.ft,b)}else U(c)}function ee(e,t,r){console.log("onClick",e,t,r)}window.addEventListener("keydown",e=>{let t=1*(e.shiftKey?10:1);e.key==="ArrowUp"&&(c=Math.min(c+t,T)),e.key==="ArrowDown"&&(c=Math.max(c-t,0)),e.key==="Home"&&(c=0),e.key==="End"&&(c=T),e.key==="ArrowLeft"&&(b=Math.max(b-t,0)),e.key==="ArrowRight"&&(b=Math.min(b+t,H)),m=Math.max(m,1)});let m=1,k=1,y={x:window.innerWidth/2-200,y:200},R=!1;function te(e){(e.x!==0||e.y!==0)&&(R=!0,m=Math.max(m,1),y.x+=e.x,y.y+=e.y)}function q(e,t){k*=t,y.x=e.x-(e.x-y.x)*t,y.y=e.y-(e.y-y.y)*t,m=Math.max(m,1)}async function Y(){m>0&&(m--,d.width=window.innerWidth,d.height=window.innerHeight,u.clearRect(0,0,d.width,d.height),u.setTransform(k,0,0,k,y.x,y.y),await J(),u.setTransform(1,0,0,1,0,0),j()),requestAnimationFrame(Y)}window.onresize=()=>Math.max(m,1);d.oncontextmenu=e=>e.preventDefault();d.addEventListener("mousemove",O);d.addEventListener("mousedown",O);d.addEventListener("mouseup",O);d.addEventListener("mouseout",O);d.addEventListener("wheel",re,{passive:!1});const a={x:0,y:0,oldX:0,oldY:0,button:!1};function O(e){if(e.type==="mousedown"&&(a.button=!0,R=!1),e.type==="mouseup"||e.type==="mouseout"){if(a.button&&R==!1){const t=1/k;ee(Math.ceil((a.x-y.x)*t),Math.ceil((a.y-y.y)*t),e.button)}a.button=!1}a.oldX=a.x,a.oldY=a.y,a.x=e.offsetX,a.y=e.offsetY,a.button&&te({x:a.x-a.oldX,y:a.y-a.oldY})}function re(e){var t=e.offsetX,r=e.offsetY;e.deltaY<0?q({x:t,y:r},1.1):q({x:t,y:r},1/1.1),e.preventDefault()}requestAnimationFrame(Y);
