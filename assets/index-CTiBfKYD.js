var W=Object.defineProperty;var q=(e,t,r)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var c=(e,t,r)=>(q(e,typeof t!="symbol"?t+"":t,r),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function r(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=r(i);fetch(i.href,o)}})();class M{constructor(t){c(this,"feature_set","");c(this,"num_features",0);c(this,"layers",[]);const r=new U(t);switch(this.feature_set=r.readString(),this.feature_set){case"half-compact":this.num_features=192;break;case"half-piece":this.num_features=768;break;case"half-king-piece":this.num_features=40960;break}const s=256,i=32,o=32;this.layers.push(w.read(r,this.num_features,s,16,16)),this.layers.push(w.read(r,2*s,i,8,32)),this.layers.push(w.read(r,i,o,8,32)),this.layers.push(w.read(r,o,1,8,32)),console.assert(r.isEOF(),"Failed to read entire NN file")}get ft(){return this.layers[0]}static async load(t){let s=await(await fetch(t)).arrayBuffer();return new M(s)}}class w{constructor(){c(this,"num_inputs");c(this,"num_outputs");c(this,"weight");c(this,"bias")}static read(t,r,s,i,o){let n=new w;return n.num_inputs=r,n.num_outputs=s,n.weight=t.readIntArray(r*s,i),n.bias=t.readIntArray(s,o),n}getWeightRow(t){let r=new Array(this.num_inputs);for(let s=0;s<this.num_inputs;s++)r[s]=this.weight[s*this.num_outputs+t];return r}getWeightFT(t,r){return this.weight[t*this.num_outputs+r]}}class U{constructor(t){c(this,"dv");c(this,"offset",0);this.dv=new DataView(t)}readString(){let t="";for(;this.dv.getUint8(this.offset)!==0;)t+=String.fromCharCode(this.dv.getUint8(this.offset++));return this.offset++,t}readInt8Array(t){let r=new Int8Array(t);for(let s=0;s<t;s++)r[s]=this.dv.getInt8(this.offset++);return r}readInt16Array(t){let r=new Int16Array(t);for(let s=0;s<t;s++)r[s]=this.dv.getInt16(this.offset,!0),this.offset+=2;return r}readInt32Array(t){let r=new Int32Array(t);for(let s=0;s<t;s++)r[s]=this.dv.getInt32(this.offset,!0),this.offset+=4;return r}readIntArray(t,r){switch(r){case 8:return this.readInt8Array(t);case 16:return this.readInt16Array(t);case 32:return this.readInt32Array(t)}}isEOF(){return this.offset===this.dv.byteLength}}const Y=["w","b"],F=["P","N","B","R","Q","K"],O=new Map,C=new Map;function D(e,t,r,s,i){let o=4,n=15,p=5;for(let f=0;f<s.num_outputs;f++){let d=t+f%o*n,y=r+Math.floor(f/o)*n;if(f==i){e.lineWidth=1;for(let g=0;g<768;g++){if(!O.has(g+""))continue;let[I,E]=O.get(g+""),v=s.getWeightFT(g,i),S="rgba("+(v>0?"0, 255, 0":"255, 0, 0")+", "+Math.abs(v/300)+")";e.strokeStyle=S,e.beginPath(),e.moveTo(I,E),e.lineTo(d,y),e.stroke()}}e.fillStyle="rgba(255, 255, 255, 0.2)",e.strokeStyle="white",e.lineWidth=1,e.beginPath(),e.arc(d,y,p,0,2*Math.PI),e.stroke(),e.fill()}}const l=16;function X(e,t,r,s){console.assert(s.length==64,"Invalid number of cells");let i="#f0d9b5",o="#b58863";for(let n=0;n<64;n++){let p=n%8,f=Math.floor(n/8),d=p*l+t,y=f*l+r;e.fillStyle=(p+f)%2==0?i:o,e.fillRect(d,y,l,l);let{role:g,color:I,opacity:E,text:v,accent:S,coords_key:N}=s[n];if(S&&(e.fillStyle=S,e.fillRect(d,y,l,l)),g&&I){let x=I+g,P=C.get(x);P&&(e.globalAlpha=E===void 0?1:E,e.drawImage(P,d,y,l,l),e.globalAlpha=1)}v&&(e.textAlign="left",e.font="4px Arial",e.fillStyle="white",e.fillText(`${v}`,d+1,y+l-1)),N&&O.set(N,[d+l/2,y+l/2])}}function $(e,t,r){for(let s=0;s<12;s++)X(e,0,s*150,Array.from({length:64},(i,o)=>{let n=64*s+o,p=t.getWeightFT(n,r),f=Math.abs(p/300);return{text:`${n}`,accent:"rgba("+(p>0?"0, 255, 0":"255, 0, 0")+", "+f+")",coords_key:`${n}`,color:s<6?"w":"b",role:F[s%6],opacity:f}}));e.font="20px monospace",e.textAlign="center",e.fillStyle="white",e.fillText("Half-Piece",l*8/2,-30),e.fillText("[768]",l*8/2,-10)}async function B(){for(let e of Y)for(let t of F){let r=new Image;r.src=`pieces/${e}${t}.svg`,C.set(e+t,r)}}B();const u=document.querySelector("canvas"),b=u.getContext("2d");let A=null;M.load("best.nn").then(e=>{A=e,m=2,console.log(A)});async function H(){b.imageSmoothingEnabled=!1,A&&(D(b,400,0,A.ft,3),$(b,A.ft,3))}function z(e,t,r){console.log("onClick",e,t,r)}let m=1,_=1,h={x:0,y:0},R=!1;function K(e){(e.x!==0||e.y!==0)&&(R=!0,m=Math.max(m,1),h.x+=e.x,h.y+=e.y)}function T(e,t){_*=t,h.x=e.x-(e.x-h.x)*t,h.y=e.y-(e.y-h.y)*t,m=Math.max(m,1)}async function k(){m>0&&(m--,u.width=window.innerWidth,u.height=window.innerHeight,b.setTransform(1,0,0,1,0,0),b.clearRect(0,0,u.width,u.height),b.setTransform(_,0,0,_,h.x,h.y),await H()),requestAnimationFrame(k)}window.onresize=()=>Math.max(m,1);u.oncontextmenu=e=>e.preventDefault();u.addEventListener("mousemove",L);u.addEventListener("mousedown",L);u.addEventListener("mouseup",L);u.addEventListener("mouseout",L);u.addEventListener("wheel",Q,{passive:!1});const a={x:0,y:0,oldX:0,oldY:0,button:!1};function L(e){if(e.type==="mousedown"&&(a.button=!0,R=!1),e.type==="mouseup"||e.type==="mouseout"){if(a.button&&R==!1){const t=1/_;z(Math.ceil((a.x-h.x)*t),Math.ceil((a.y-h.y)*t),e.button)}a.button=!1}a.oldX=a.x,a.oldY=a.y,a.x=e.offsetX,a.y=e.offsetY,a.button&&K({x:a.x-a.oldX,y:a.y-a.oldY})}function Q(e){var t=e.offsetX,r=e.offsetY;e.deltaY<0?T({x:t,y:r},1.1):T({x:t,y:r},1/1.1),e.preventDefault()}requestAnimationFrame(k);
