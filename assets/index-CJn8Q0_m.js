var q=Object.defineProperty;var Y=(e,t,r)=>t in e?q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var c=(e,t,r)=>(Y(e,typeof t!="symbol"?t+"":t,r),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function r(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=r(i);fetch(i.href,o)}})();class M{constructor(t){c(this,"feature_set","");c(this,"num_features",0);c(this,"layers",[]);const r=new D(t);switch(this.feature_set=r.readString(),this.feature_set){case"half-compact":this.num_features=192;break;case"half-piece":this.num_features=768;break;case"half-king-piece":this.num_features=40960;break}const s=256,i=32,o=32;this.layers.push(w.read(r,this.num_features,s,16,16)),this.layers.push(w.read(r,2*s,i,8,32)),this.layers.push(w.read(r,i,o,8,32)),this.layers.push(w.read(r,o,1,8,32)),console.assert(r.isEOF(),"Failed to read entire NN file")}get ft(){return this.layers[0]}static async load(t){let s=await(await fetch(t)).arrayBuffer();return new M(s)}}class w{constructor(){c(this,"num_inputs");c(this,"num_outputs");c(this,"weight");c(this,"bias")}static read(t,r,s,i,o){let n=new w;return n.num_inputs=r,n.num_outputs=s,n.weight=t.readIntArray(r*s,i),n.bias=t.readIntArray(s,o),n}getWeightRow(t){let r=new Array(this.num_inputs);for(let s=0;s<this.num_inputs;s++)r[s]=this.weight[s*this.num_outputs+t];return r}getWeightFT(t,r){return this.weight[t*this.num_outputs+r]}}class D{constructor(t){c(this,"dv");c(this,"offset",0);this.dv=new DataView(t)}readString(){let t="";for(;this.dv.getUint8(this.offset)!==0;)t+=String.fromCharCode(this.dv.getUint8(this.offset++));return this.offset++,t}readInt8Array(t){let r=new Int8Array(t);for(let s=0;s<t;s++)r[s]=this.dv.getInt8(this.offset++);return r}readInt16Array(t){let r=new Int16Array(t);for(let s=0;s<t;s++)r[s]=this.dv.getInt16(this.offset,!0),this.offset+=2;return r}readInt32Array(t){let r=new Int32Array(t);for(let s=0;s<t;s++)r[s]=this.dv.getInt32(this.offset,!0),this.offset+=4;return r}readIntArray(t,r){switch(r){case 8:return this.readInt8Array(t);case 16:return this.readInt16Array(t);case 32:return this.readInt32Array(t)}}isEOF(){return this.offset===this.dv.byteLength}}const k=["w","b"],T=["P","N","B","R","Q","K"],O=new Map,N=new Map;function X(e,t,r,s,i){let o=4,n=15,p=5,A=t+i%o*n,d=r+Math.floor(i/o)*n;for(let l=0;l<768;l++){if(!O.has(l+""))continue;let[y,g]=O.get(l+""),E=s.getWeightFT(l,i),I=Math.abs(E/300),S="rgba("+(E>0?"0, 255, 0":"255, 0, 0")+", "+I+")";I<=.03||(e.strokeStyle=S,e.beginPath(),e.moveTo(y,g),e.lineTo(A,d),e.stroke())}for(let l=0;l<s.num_outputs;l++){let y=t+l%o*n,g=r+Math.floor(l/o)*n;l==i?(e.fillStyle="gray",e.strokeStyle="white"):(e.fillStyle="#454545",e.strokeStyle="#6A6A6A"),e.lineWidth=1,e.beginPath(),e.arc(y,g,p,0,2*Math.PI),e.closePath(),e.stroke(),e.fill()}e.lineWidth=1}const f=16;function $(e,t,r,s){console.assert(s.length==64,"Invalid number of cells");let i="#f0d9b5",o="#b58863";for(let n=0;n<64;n++){let p=n%8,A=Math.floor(n/8),d=p*f+t,l=A*f+r;e.fillStyle=(p+A)%2==0?i:o,e.fillRect(d,l,f,f);let{role:y,color:g,opacity:E,text:I,accent:S,coords_key:F}=s[n];if(S&&(e.fillStyle=S,e.fillRect(d,l,f,f)),y&&g){let W=g+y,P=N.get(W);if(P){let H=E===void 0?1:E;H>.03&&(e.globalAlpha=H,e.drawImage(P,d,l,f,f),e.globalAlpha=1)}}I&&(e.textAlign="left",e.font="4px Arial",e.fillStyle="white",e.fillText(`${I}`,d+1,l+f-1)),F&&O.set(F,[d+f/2,l+f/2])}}function x(e,t,r){for(let s=0;s<12;s++){let i=k[+(s>=6)],o=T[s%6],n=s*150;$(e,0,n,Array.from({length:64},(A,d)=>{let l=64*s+d,y=t.getWeightFT(l,r),g=Math.abs(y/300);return{text:`${l}`,accent:"rgba("+(y>0?"0, 255, 0":"255, 0, 0")+", "+g+")",coords_key:`${l}`,color:i,role:T[s%6],opacity:g}}));let p=N.get(i+o);p&&e.drawImage(p,-64,n+8*f/2-32/2,32,32)}e.font="20px monospace",e.textAlign="center",e.fillStyle="white",e.fillText("Half-Piece",f*8/2,-30),e.fillText("[768]",f*8/2,-10)}async function B(){for(let e of k)for(let t of T){let r=new Image;r.src=`pieces/${e}${t}.svg`,N.set(e+t,r)}}B();const u=document.querySelector("canvas"),b=u.getContext("2d");let v=null;M.load("best.nn").then(e=>{v=e,m=2,console.log(v)});async function G(){b.imageSmoothingEnabled=!1,v&&(X(b,400,1800/2-960/2,v.ft,3),x(b,v.ft,3))}function z(e,t,r){console.log("onClick",e,t,r)}let m=1,_=1,h={x:0,y:0},R=!1;function K(e){(e.x!==0||e.y!==0)&&(R=!0,m=Math.max(m,1),h.x+=e.x,h.y+=e.y)}function C(e,t){_*=t,h.x=e.x-(e.x-h.x)*t,h.y=e.y-(e.y-h.y)*t,m=Math.max(m,1)}async function U(){m>0&&(m--,u.width=window.innerWidth,u.height=window.innerHeight,b.setTransform(1,0,0,1,0,0),b.clearRect(0,0,u.width,u.height),b.setTransform(_,0,0,_,h.x,h.y),await G()),requestAnimationFrame(U)}window.onresize=()=>Math.max(m,1);u.oncontextmenu=e=>e.preventDefault();u.addEventListener("mousemove",L);u.addEventListener("mousedown",L);u.addEventListener("mouseup",L);u.addEventListener("mouseout",L);u.addEventListener("wheel",Q,{passive:!1});const a={x:0,y:0,oldX:0,oldY:0,button:!1};function L(e){if(e.type==="mousedown"&&(a.button=!0,R=!1),e.type==="mouseup"||e.type==="mouseout"){if(a.button&&R==!1){const t=1/_;z(Math.ceil((a.x-h.x)*t),Math.ceil((a.y-h.y)*t),e.button)}a.button=!1}a.oldX=a.x,a.oldY=a.y,a.x=e.offsetX,a.y=e.offsetY,a.button&&K({x:a.x-a.oldX,y:a.y-a.oldY})}function Q(e){var t=e.offsetX,r=e.offsetY;e.deltaY<0?C({x:t,y:r},1.1):C({x:t,y:r},1/1.1),e.preventDefault()}requestAnimationFrame(U);
